<!-- 3 lesson drawing in the canvas -->
<html>
	<head>
		<script type="text/javascript">
			const CANVAS_WIDTH = 640;
			const CANVAS_HEIGHT = 480;
			const COLOR_ARRAY_LENGTH = 4;
			const LIGHT_GRASS = [0, 203, 14,255];
			const DARKER_GRASS = [10,97,16,255];
			const WHITE_STRIPE = [255,255,255,255];
			const RED_STRIPE = [255,0,0,255];
			const ASPHALT = [200,200,200,255];
			const ASPHALT_MAX_WIDTH = 0.9;
			const ASPHALT_MIN_WIDTH = 0.2;
			const ASPHALT_WIDTH_STEP = (ASPHALT_MAX_WIDTH - ASPHALT_MIN_WIDTH) / (CANVAS_HEIGHT / 2);
			const STRIPE_WIDTH = 0.03;
			var canvasElement;
			var context;
			var stepControl = 2*Math.PI;	

			function initializeCanvas(){
				canvasElement = document.getElementById("game");
				context = canvasElement.getContext("2d");
				canvasElement.width = CANVAS_WIDTH;
				canvasElement.height = CANVAS_HEIGHT;
				return context;
			}

			function drawOnBuffer(x, y, color, buffer) {
				buffer[((x*4) + (y * CANVAS_WIDTH * 4))] = color[0];
				buffer[((x*4) + (y * CANVAS_WIDTH * 4))+1] = color[1];
				buffer[((x*4) + (y * CANVAS_WIDTH * 4))+2] = color[2];
				buffer[((x*4) + (y * CANVAS_WIDTH * 4))+3] = color[3];
			}
			
			function drawToCanvas(buffer){
				context = initializeCanvas();
				const image = new ImageData(buffer, CANVAS_WIDTH, CANVAS_HEIGHT);
				context.putImageData(image, 0,0);
			}

			function initializeBuffer(){
				const buffer = new ArrayBuffer(CANVAS_WIDTH*CANVAS_HEIGHT*COLOR_ARRAY_LENGTH);
				return new Uint8ClampedArray(buffer);
			}

			function drawPixels(stepGrass,curve=1500){
				const buffer = initializeBuffer();
				let color = [], stripeWidth, grassStripe =0, laneStripe = 0;
				let stepLane = stepGrass / 3, asphaltLane = CANVAS_WIDTH * ASPHALT_MIN_WIDTH;
				for (let y = CANVAS_HEIGHT/2; y < CANVAS_HEIGHT; ++y){
					laneInsertionPoint = (CANVAS_WIDTH - asphaltLane) / 2;
					if (curve != 0) { laneInsertionPoint = curveInsertionPoint(y, curve, laneInsertionPoint);}
					stripeWidth = asphaltLane * STRIPE_WIDTH;
					for (let x = 0; x < CANVAS_WIDTH; ++x){
						color = (Math.sin(grassStripe) > 0) ? LIGHT_GRASS : DARKER_GRASS;
						if(x >= laneInsertionPoint && x < laneInsertionPoint + asphaltLane) {
							color = ASPHALT;
							if (x < laneInsertionPoint + stripeWidth || x > laneInsertionPoint + asphaltLane - stripeWidth) {
								color = (Math.sin(laneStripe) > 0) ? WHITE_STRIPE : RED_STRIPE;
							}
						}
						drawOnBuffer(x, y, color, buffer);
					}
					asphaltLane += CANVAS_WIDTH * ASPHALT_WIDTH_STEP;
					laneStripe += stepLane;
					grassStripe += stepGrass;
					if(grassStripe > Math.PI*2) {stepGrass = stepGrass / 2; grassStripe = 0;}
					if(laneStripe > 2*Math.PI) {stepLane = stepLane / 2; laneStripe = 0;}
				}
				drawToCanvas(buffer);
			}
			function curveInsertionPoint(y, curve, currentInsertionPoint){
				let coeficient = Math.abs(curve);
				let xPoint = (CANVAS_HEIGHT - y) / CANVAS_HEIGHT;
				let yPoint = coeficient * xPoint * xPoint;
				return (curve > 0) ? currentInsertionPoint - yPoint : currentInsertionPoint + yPoint;
			}

			function run(){
				drawPixels(stepControl);

			}
			function addFx(){
				stepControl -= 0.1;
				if (stepControl< Math.PI) { stepControl += Math.PI; }
				run();
			}

			function correctBound(curve, y) {
				let coeficientA = (curve < 0) ? curve * -1: curve;
				return coeficientA * y * y + 0.000010*y;
			}
		</script>
	</head>
	<body onload="run()" onkeypress="addFx()">
		<canvas id="game" width="640" height="480"> </canvas>
	</body>
</html>

